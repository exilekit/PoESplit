<Window x:Class="PoESplit.MapWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:PoESplit"
        xmlns:clr="clr-namespace:System;assembly=mscorlib"
        mc:Ignorable="d"
        WindowStyle="None"
        Background="Black"
        BorderThickness="2"
        ResizeMode="CanResizeWithGrip"
        Width="{Binding CanvasWidth, Mode=OneTime}"
        Height="{Binding CanvasHeight, Mode=OneTime}"
        AllowsTransparency="True"
        DataContext="{Binding RelativeSource={RelativeSource Mode=Self}}"
        Title="Map" MouseDown="Window_MouseDown">
    <Window.Resources>
        <ResourceDictionary>
            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
            <local:CenteringMultiValueConverter x:Key="CenteringMultiValueConverter"/>
            <BitmapImage x:Key="WorldPanelVisitedPinIcon" UriSource="/PoESplit;component/ExileKit/WorldPanelVisitedPinIcon.png"/>
            <BitmapImage x:Key="WorldPanelTownPinIcon" UriSource="/PoESplit;component/ExileKit/WorldPanelTownPinIcon.png"/>
            <BitmapImage x:Key="WorldPanelActivatedWaypointPinIcon" UriSource="/PoESplit;component/ExileKit/WorldPanelActivatedWaypointPinIcon.png"/>
            <clr:Double x:Key="PlayerMarkerSize">60</clr:Double>

            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="MarkupTemplates\MapConnections.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Window.Resources>
    <Viewbox Stretch="Uniform">
        <Grid Background="Yellow">
            <Image Source="{Binding BackgroundImageSource}"/>

            <Control Template="{StaticResource MapConnectionsWhite }"/>
            <Control Template="{StaticResource MapConnectionsBlack }"/>

            <ItemsControl ItemsSource="{Binding MapPins}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas Width="{Binding CanvasWidth}" Height="{Binding CanvasHeight}"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemContainerStyle>
                    <Style>
                        <Setter Property="Canvas.Left">
                            <Setter.Value>
                                <MultiBinding Converter="{StaticResource CenteringMultiValueConverter}">
                                    <Binding Path="X"/>
                                    <Binding Source="{StaticResource WorldPanelVisitedPinIcon}" Path="Width"/>
                                </MultiBinding>
                            </Setter.Value>
                        </Setter>
                        <Setter Property="Canvas.Top">
                            <Setter.Value>
                                <MultiBinding Converter="{StaticResource CenteringMultiValueConverter}">
                                    <Binding Path="Y"/>
                                    <Binding Source="{StaticResource WorldPanelVisitedPinIcon}" Path="Height"/>
                                </MultiBinding>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ItemsControl.ItemContainerStyle>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Image>
                            <Image.Style>
                                <Style TargetType="Image">
                                    <Style.Triggers>
                                        <MultiDataTrigger>
                                            <MultiDataTrigger.Conditions>
                                                <Condition Binding="{Binding IsWaypoint}" Value="False"/>
                                                <Condition Binding="{Binding IsTown}" Value="False"/>
                                            </MultiDataTrigger.Conditions>
                                            <Setter Property="Source" Value="{StaticResource WorldPanelVisitedPinIcon}"/>
                                        </MultiDataTrigger>
                                        <DataTrigger Binding="{Binding IsWaypoint}" Value="True">
                                            <Setter Property="Source" Value="{StaticResource WorldPanelActivatedWaypointPinIcon}"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsTown}" Value="True">
                                            <Setter Property="Source" Value="{StaticResource WorldPanelTownPinIcon}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Image.Style>
                        </Image>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <Canvas Width="{Binding CanvasWidth}" Height="{Binding CanvasHeight}">
                <Ellipse 
                    Width="{Binding Source={StaticResource PlayerMarkerSize}}" 
                    Height="{Binding Source={StaticResource PlayerMarkerSize}}"
                    Visibility="{Binding PlayerPositionKnown, Converter={StaticResource BooleanToVisibilityConverter}}"
                    Stroke="Red" 
                    StrokeThickness="5">
                    <Ellipse.Style>
                        <Style TargetType="{x:Type Ellipse}">
                            <Setter Property="Canvas.Left">
                                <Setter.Value>
                                    <MultiBinding Converter="{StaticResource CenteringMultiValueConverter}">
                                        <Binding Path="PlayerX"/>
                                        <Binding Source="{StaticResource PlayerMarkerSize}"/>
                                    </MultiBinding>
                                </Setter.Value>
                            </Setter>
                            <Setter Property="Canvas.Top">
                                <Setter.Value>
                                    <MultiBinding Converter="{StaticResource CenteringMultiValueConverter}">
                                        <Binding Path="PlayerY"/>
                                        <Binding Source="{StaticResource PlayerMarkerSize}"/>
                                    </MultiBinding>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Ellipse.Style>
                </Ellipse>


            </Canvas>
        </Grid>
    </Viewbox>
</Window>